---
description: 
globs: 
alwaysApply: false
---
# Bitcoin Price Tracking System Implementation

This document outlines the implementation of the Bitcoin price tracking system for the BitBasis project. The system includes historical price data collection, hourly price updates, and utilities for accessing and displaying Bitcoin price data.

## Components Overview

The Bitcoin price tracking system consists of:

1. **Database Table**: `historical_prices` table in Supabase for storing price data
2. **Edge Function**: `update-price` Supabase Edge Function for hourly price updates
3. **Cron Job**: Database cron job that triggers the edge function
4. **Import Script**: JavaScript script for one-time import of historical data
5. **Utility Functions**: TypeScript utilities for accessing price data in frontend components
6. **Test Component**: Component for verifying the implementation works correctly

## Database Structure

The `historical_prices` table has the following structure:

```sql
CREATE TABLE IF NOT EXISTS historical_prices (
    id BIGSERIAL PRIMARY KEY,
    timestamp BIGINT NOT NULL,
    price_usd NUMERIC(20, 2) NOT NULL,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT unique_timestamp UNIQUE (timestamp)
);
```

## Implementation Details

### 1. Edge Function

The edge function is deployed to Supabase and is responsible for fetching the current Bitcoin price from the Mempool.space API and storing it in the database. It's triggered hourly by a cron job.

**Key features:**
- Uses Mempool.space API to get current BTC price
- Stores price with Unix timestamp (seconds)
- Error handling and logging
- Deployed to Supabase cloud functions

### 2. Historical Data Import

A Node.js script that imports historical Bitcoin price data from Mempool.space API. The script:

- Fetches historical data from multiple sources (with fallbacks)
- Processes and formats the data
- Imports the data in batches to avoid size limits
- Creates a backup JSON file of the imported data

The script successfully imported over 21,000 historical price points.

### 3. Frontend Utilities

TypeScript utilities in `lib/bitcoin-prices.ts` provide easy access to price data:

- `getCurrentPrice()`: Gets the most recent Bitcoin price
- `getHistoricalPrices(startTimestamp, endTimestamp, interval)`: Gets historical prices for a specified range
- `getAllTimeHighPrice()`: Gets the all-time high Bitcoin price

These functions include caching, error handling, and query optimization based on the requested time interval.

### 4. Test Component

A test component (`components/bitcoin-price-test.tsx`) demonstrates how to use the utility functions and display Bitcoin price data:

- Shows current price
- Shows all-time high price
- Displays a chart with historical price data
- Includes refresh buttons for testing

## How to Use

### Access Bitcoin Price Data in Components

```typescript
import { getCurrentPrice, getHistoricalPrices, getAllTimeHighPrice } from '@/lib/bitcoin-prices';

// In an async function or component:
const currentPrice = await getCurrentPrice();
console.log(`Current BTC price: $${currentPrice?.price_usd.toLocaleString()}`);

// Get historical prices for the last 30 days:
const endDate = Math.floor(Date.now() / 1000); // Current time in seconds
const startDate = endDate - (30 * 24 * 60 * 60); // 30 days ago
const historicalPrices = await getHistoricalPrices(startDate, endDate, 'day');

// Get all-time high:
const ath = await getAllTimeHighPrice();
console.log(`ATH: $${ath?.price_usd.toLocaleString()} on ${ath?.date}`);
```

### Update Bitcoin Price Manually

To manually trigger a price update:

```bash
curl -X POST https://npcvbxrshuflujcnikon.supabase.co/functions/v1/update-price \
  -H "Authorization: Bearer YOUR_ANON_KEY"
```

## Implementation Checklist

- [x] Database table created via migrations
- [x] Edge function created and deployed
- [x] Historical data import script created and executed
- [x] Frontend utility functions implemented
- [x] Test component created for verification
- [x] Hourly cron job configured for ongoing updates

## Maintenance

The system is designed to be low-maintenance:

- Prices update automatically every hour via the cron job
- The historical import is a one-time operation
- The utility functions handle caching and query optimization

If further maintenance is needed:

1. Check Supabase logs for edge function errors
2. Verify the database is being updated hourly
3. Update the edge function if the API changes

## Future Improvements

Potential future enhancements:

1. Add alternative API sources in the edge function (like in the import script)
2. Implement a data retention policy for very old price points
3. Add price alert features
4. Create more advanced chart visualizations

## Troubleshooting

If issues occur:

- Verify the edge function is deployed correctly
- Check Supabase logs for errors
- Test the API endpoints directly
- Verify database permissions and RLS policies
- Check for rate limiting on the Mempool.space API

## Implementation Notes

- The system uses Unix timestamps (seconds since epoch) for all date handling
- All prices are stored in USD only
- Query optimization is built in to handle large date ranges efficiently
- The system includes fallback mechanisms if primary data sources fail 