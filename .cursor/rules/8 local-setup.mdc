---
description: 
globs: 
alwaysApply: true
---
# Local Development Environment Setup

## Required Environment Variables
The following environment variables must be set in `.env`:
- `SUPABASE_PROJECT_REF`: Project reference ID
- `POSTGRES_PASSWORD`: Database password
- `SUPABASE_DB_PASSWORD`: Same as POSTGRES_PASSWORD (required by Supabase CLI)
- `DATABASE_URL`: Full database connection string

## Current Configuration

### Project Details
- **Project ID:** npcvbxrshuflujcnikon
- **Project Reference:** npcvbxrshuflujcnikon
- **Environment:** Local Docker-based Supabase setup

### Active Services

#### Database
- **Host:** localhost
- **Port:** 54322
- **User:** postgres
- **Password:** postgres
- **Database:** postgres
- **Connection String:** `postgresql://postgres:postgres@localhost:54322/postgres`

#### Management UI
- **Supabase Studio:** http://localhost:54323
- **API Gateway:** http://localhost:54321

#### Running Docker Containers
All containers are prefixed with `supabase_` and suffixed with `_BitBasis_Project`:
- Studio (Port 54323)
- PostgreSQL Database (Port 54322)
- Kong API Gateway (Port 54321)
- Auth Service
- Storage API
- Realtime Service
- Analytics (Port 54327)
- Mail Service (Port 54324)

### Development Workflow

#### Local Development
1. Start Supabase services:
   ```bash
   supabase start
   ```

2. Verify services are running:
   ```bash
   supabase status
   ```

3. Create migrations in `supabase/migrations/` directory:
   ```sql
   -- Example: 20240329_example.sql
   CREATE TABLE public.example (...);
   ```

4. Test migrations locally:
   ```bash
   # Direct PostgreSQL command
   PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -f supabase/migrations/your_migration.sql
   ```

#### Remote Synchronization
1. Link to remote project:
   ```bash
   # Set password as environment variable to handle special characters
   export SUPABASE_DB_PASSWORD='your_password'
   
   # Link project
   supabase link --project-ref npcvbxrshuflujcnikon
   ```

2. Push changes to remote:
   ```bash
   # Push all pending migrations
   supabase db push --include-all
   ```

3. Pull remote changes:
   ```bash
   supabase db pull
   ```

4. Verify remote functions after migration:
   ```bash
   # View function definition
   PGPASSWORD=$SUPABASE_DB_PASSWORD psql "postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres" -c "\df+ function_name"
   
   # Test function execution
   PGPASSWORD=$SUPABASE_DB_PASSWORD psql "postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres" -c "SELECT public.your_function();"
   ```

### Remote Database Connections

#### Connection Strings
- **Connection Pooler (Preferred):**
  ```
  postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres
  ```

- **Direct Connection (Use pooler instead if DNS issues occur):**
  ```
  postgresql://postgres@db.npcvbxrshuflujcnikon.supabase.co:5432/postgres
  ```

#### Connecting via PSQL
```bash
# Export password to environment
export SUPABASE_DB_PASSWORD='your_password'

# Connect using pooler URL
PGPASSWORD=$SUPABASE_DB_PASSWORD psql "postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres"

# Or run a single command
PGPASSWORD=$SUPABASE_DB_PASSWORD psql "postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres" -c "YOUR_QUERY"
```

### Project Structure
```
supabase/
├── migrations/    # Database migration files
├── functions/     # Edge functions
├── seed/          # Seed data
└── config.toml    # Supabase configuration
```

### Quick Verification Commands
```bash
# Check container status
docker ps

# Verify database connection
PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -c "\dt"

# List database schemas
PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -c "\dn"

# Check remote migration status
supabase migration list --linked

# View function definitions in remote
PGPASSWORD=$SUPABASE_DB_PASSWORD psql "postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres" -c "\df+ public.function_name"
```

### Testing Queries
To test SQL queries in the terminal, use the following format:

#### Local Database
```bash
# Basic query structure
PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -c "YOUR_QUERY" | cat

# Examples:
# Select all from a table
PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -c "SELECT * FROM public.your_table;" | cat

# View table structure
PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -c "\d+ public.your_table" | cat

# Insert with returning
PGPASSWORD=postgres psql -h localhost -p 54322 -U postgres -d postgres -c "INSERT INTO public.your_table (column) VALUES ('value') RETURNING *;" | cat
```

#### Remote Database
```bash
# Query remote database
PGPASSWORD=$SUPABASE_DB_PASSWORD psql "postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres" -c "SELECT * FROM public.your_table LIMIT 5;"

# Test function in remote
PGPASSWORD=$SUPABASE_DB_PASSWORD psql "postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres" -c "SELECT public.your_function();"

# Apply SQL directly to remote (for hotfixes)
PGPASSWORD=$SUPABASE_DB_PASSWORD psql "postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres" -f hotfix.sql
```

### Troubleshooting

#### Remote Connection Issues
- If DNS resolution fails for `db.npcvbxrshuflujcnikon.supabase.co`, use the pooler URL `aws-0-us-east-2.pooler.supabase.com:6543`
- Use `export SUPABASE_DB_PASSWORD='your_password'` before connecting to handle special characters
- The Supabase CLI sometimes has issues with direct database operations - use `psql` for troubleshooting

#### Migration Issues
- Verify function definitions after pushing migrations:
  ```bash
  PGPASSWORD=$SUPABASE_DB_PASSWORD psql "postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres" -c "\df+ public.your_function"
  ```
- If a function has issues, apply it directly:
  ```bash
  PGPASSWORD=$SUPABASE_DB_PASSWORD psql "postgresql://postgres.npcvbxrshuflujcnikon@aws-0-us-east-2.pooler.supabase.com:6543/postgres" -c "CREATE OR REPLACE FUNCTION..."
  ```

#### Function Development Guidelines
- Always explicitly set NOT NULL columns in INSERT statements, even if they have defaults:
  ```sql
  INSERT INTO table_name (column1, column2, column_with_default) 
  VALUES (value1, value2, default_value);
  ```
- Test functions after deployment to



