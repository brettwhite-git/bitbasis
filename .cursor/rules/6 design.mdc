---
description: 
globs: 
alwaysApply: true
---
## Design
- **Theme:**
  - Dark mode with Bitcoin orange (`#F7931A`), black, and gray tones.
  - Use Tailwind’s `dark:` prefix (e.g., `dark:bg-gray-900`).
- **Charts:**
  - Implement Chart.js with responsive layouts and theme-matching colors.
- **CSV Handling:**
  - Support large/multiple CSVs (e.g., up to 100MB total across uploads).
  - Provide clear parsing progress and error feedback.
  - Max CSV size determined by performance testing (e.g., 10MB per file).
- **Removal Logic:**
  - Enable easy CSV deletion with cascading updates to transactions and KPIs.
  - Prompt Cursor: "Add logic to remove a CSV and update calculations."

## Data Handling
**Supabase Tables**
**Login Table for User**
- `users`: `id`, `email` (minimal info, unchanged).


#### Core Fields
- `id`: Auto-incrementing primary key
- `created_at`: Timestamp of record creation
- `updated_at`: Timestamp of last update
- `user_id`: Foreign key to auth.users table
- `date`: Transaction date and time
- `type`: Transaction type (Buy/Sell/Send/Receive)
- `asset`: Cryptocurrency asset (e.g., "BTC")

#### Amount Fields
- `sent_amount`: Amount sent in a transaction
- `sent_currency`: Currency of sent amount
- `buy_amount`: Amount bought in a purchase
- `buy_currency`: Currency of purchase
- `sell_amount`: Amount sold in a sale
- `sell_currency`: Currency of sale
- `price`: Price per unit at time of transaction
- `received_amount`: Amount received in transaction
- `received_currency`: Currency of received amount

#### Additional Details
- `exchange`: Exchange where transaction occurred

#### Fee Information
- `network_fee`: Network/blockchain fee
- `network_currency`: Currency of network fee
- `service_fee`: Exchange/service fee
- `service_fee_currency`: Currency of service fee


### Usage Guidelines
**Transaction Types**:
   - `Buy`: Use `buy_amount`, `buy_currency`, `received_amount`
   - `Sell`: Use `sell_amount`, `sell_currency`, 
   - `Send`: Use `sent_amount`, `sent_currency`
   - `Receive`: Use `received_amount`, `received_currency`

**Amount Handling**:
   - For buys: Primary amount is `received_amount` (in BTC)
   - For sells: Primary amount is `sell_amount` (in BTC)
   - For sends: Use `sent_amount`
   - For receives: Use `received_amount`

**Fee Calculation**:
   - Total fees = `network_fee` + `service_fee`
   - Always store fees in the transaction's currency

**Data Validation**:
   - All amounts must be positive
   - Required fields: `date`, `type`, `asset`, `price`
   - Currency fields must be present if corresponding amount is present 


**Bitcoing Price Table**
- `bitcoin_prices`: `date`, `price_usd` (for caching CoinGecko data, unchanged).

- **CSV Parsing:**
  - Process CSVs server-side; validate data before insertion.
  - Store raw CSVs in Supabase Storage for user reference.

## Calculations 
  - Portfolio Value: Sum of current value of all BTC (requires current BTC price).
  - Total Cost Basis: Sum of Total USD + Fee USD for all "Buy" transactions.
  - Unrealized Gains: (Current BTC Price × Total BTC Held) - Total Cost Basis.
  - Average Buy Price: Total Cost Basis / Total BTC Bought.
  - Total ROI 
  - 30 Day Change 
  - YTD Change 
  - All Time High 

## Workflow
- **Development:**
  - Run locally with `npm run dev`.
  - Commit frequently (e.g., `git commit -m "feat: add cost basis comparison"`).
  - Deploy to Vercel; monitor performance metrics.
- **Testing:**
  - Test CSV imports with small (1KB) and large (10MB) files.
  - Validate RLS across multiple user accounts.
  - Check SEO with Lighthouse or similar tools.

