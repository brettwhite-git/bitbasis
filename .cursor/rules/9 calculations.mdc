---
description: 
globs: 
alwaysApply: true
---
# Portfolio Calculations

This document outlines the core calculations used in BitBasis for portfolio metrics.

## Total BTC Calculation

The total BTC balance is calculated using buy and sell orders only:

```typescript
Total BTC = Sum(Buy Orders BTC Received) - Sum(Sell Orders BTC Sold)
```

Note: Send and receive transactions are tracked separately and not included in the core portfolio metrics.

## Cost Basis Calculation

The total cost basis is calculated from buy orders and includes:
1. The fiat amount paid for BTC (`buy_fiat_amount`)
2. Any service fees in USD (`service_fee` where `service_fee_currency === 'USD'`)

```typescript
Total Cost Basis = Sum(Buy Orders Fiat Amount + Service Fees)
```

## Unrealized Gains

Unrealized gains are calculated using:
1. Current portfolio value (Total BTC × Current BTC Price)
2. Total cost basis

```typescript
Unrealized Gain = Current Value - Total Cost Basis
Unrealized Gain % = (Unrealized Gain / Total Cost Basis) × 100
```

## Average Buy Price

The average buy price represents the average cost per BTC:

```typescript
Average Buy Price = Total Cost Basis / Total BTC
```

## Holdings Age

Holdings are classified as:
- Short-term: Held less than 1 year
- Long-term: Held 1 year or more

The calculation:
1. Processes buy orders chronologically
2. When selling, reduces holdings proportionally from both short and long-term buckets

## Send/Receive Transactions

Send and receive transactions are tracked separately from the core portfolio metrics:

```typescript
Net Transfers = Sum(Receive Amounts) - Sum(Send Amounts)
```

These transactions do not affect the cost basis or unrealized gain calculations. 